@using SPTarkov.Server.Core.Models.Common
@using SPTarkov.Server.Core.Models.Spt.Mod

@inject ISnackbar Snackbar

<MudCard Outlined="true" Class="overflow-y-auto pa-4 ma-2">
    <MudCardHeader>BaseInfo</MudCardHeader>
    
    @* Id | ParentId | CloneId | HandbookParentId *@
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudTooltip Text="BaseInfo.Id">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.Id" Label="Id*" HelperText="物品的唯一MongoId类型Id"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.ParentId">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.ParentId" Label="ParentId*" HelperText="物品的唯一MongoId类型ParentId"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.CloneId">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.CloneId" Label="CloneId" HelperText="物品克隆的物品的Id"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.HandbookParentId">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.HandbookParentId" Label="HandbookParentId" HelperText="物品手册类型Id"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>
    </MudStack>
    
    @* SicType *@
    <MudTooltip Text="BaseInfo.Type">
        <MudSelect T="string" @bind-Value="BaseInfo.Type" Typo="Typo.body1" Style="width: auto" Label="SicType*">
            @foreach (string sicType in SicType.AllSicType)
            {
                <MudSelectItem Value="@sicType">@sicType</MudSelectItem>
            }
        </MudSelect>
    </MudTooltip>
    
    @* 名字, 描述, 作者, 协议, 加载顺序 *@
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudTooltip Text="BaseInfo.Name">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.Name" Label="名字" HelperText="@($"没有提供locales时的物品名称, 默认为{Default.BaseInfoName}")"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>

        <MudTooltip Text="BaseInfo.Description">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.Description" Label="描述" HelperText="@($"没有提供locales时的物品描述, 默认为'{Default.BaseInfoDescription}'")"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>

        <MudTooltip Text="BaseInfo.Author">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.Author" Label="作者" HelperText="@($"默认为{Default.BaseInfoAuthor}")"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>

        <MudTooltip Text="BaseInfo.License">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.Author" Label="协议" HelperText="@($"默认为{Default.BaseInfoLicense}")"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>

        <MudTooltip Text="BaseInfo.Order">
            <MudNumericField @bind-Value="BaseInfo.Order" Label="加载顺序"
                             HelperText="影响新物品的创建顺序, 数值越大加载越慢"
                             Variant="Variant.Filled" Min="0" Max="@int.MaxValue"/>
        </MudTooltip>
    </MudStack>
    
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudTooltip Text="BaseInfo.TraderId">
            <MudTextField Typo="Typo.body1" @bind-Value="BaseInfo.TraderId" Label="TraderId" HelperText="售卖该物品的商人Id"
                          Variant="Variant.Filled" Clearable="true"/>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.FleaPrice">
            <MudNumericField @bind-Value="BaseInfo.FleaPrice" Label="跳蚤市场价格"
                             Variant="Variant.Filled" Min="1" Max="@double.MaxValue"/>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.HandbookPrice">
            <MudNumericField @bind-Value="BaseInfo.HandbookPrice" Label="手册价格"
                             Variant="Variant.Filled" Min="1" Max="@double.MaxValue"/>
        </MudTooltip>
    </MudStack>
    
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudTooltip Text="BaseInfo.CanSellOnRagfair">
            <MudSwitch @bind-Value="BaseInfo.CanSellOnRagfair">是否允许在跳蚤市场售卖</MudSwitch>
        </MudTooltip>
        
        <MudTooltip Text="BaseInfo.AllowAll">
            <MudSwitch @bind-Value="BaseInfo.AllowAll">一键允许所有容器放置本物品</MudSwitch>
        </MudTooltip>
    </MudStack>
    
    @* TODO: Prefab, UsePrefab *@
    
    @* TODO: CanFilter, CantFilter *@
    
    @* 本地化数据 *@
    <MudTooltip Text="BaseInfo.Locales">
        <MudPaper MaxHeight="350px" Class="overflow-y-auto pa-4 ma-2">
            <MudStack Row="true" AlignItems="AlignItems.Center">
                <MudText>本地化数据</MudText>
                <MudTextField Typo="Typo.body2" @bind-Value="NewLocaleName" Label="新语言名称"
                              HelperText="必须为0或2字符，例如ch, en等"
                              Variant="Variant.Filled" Clearable="true"/>
                <MudButton OnClick="@(() => OnCreateLocaleCallback())">创建本地化数据</MudButton>
            </MudStack>
            @if (BaseInfo.Locales is not null)
            {
                foreach ((string locale, LocaleDetails localeDetail) in BaseInfo.Locales)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.body2">@locale</MudText>
                        <MudTooltip Text="LocaleDetails.Name">
                            <MudTextField Typo="Typo.body2" @bind-Value="localeDetail.Name" Label="名字"
                                          Variant="Variant.Filled" Clearable="true"/>
                        </MudTooltip>
                        <MudTooltip Text="LocaleDetails.ShortName">
                            <MudTextField Typo="Typo.body2" @bind-Value="localeDetail.ShortName" Label="简称"
                                          Variant="Variant.Filled" Clearable="true"/>
                        </MudTooltip>
                        <MudTooltip Text="LocaleDetails.Description">
                            <MudTextField Typo="Typo.body2" @bind-Value="localeDetail.Description" Label="描述"
                                          Variant="Variant.Filled" Clearable="true"/>
                        </MudTooltip>
                        <MudButton OnClick="@(() => OnDeleteLocaleCallback(locale))">删除此语言</MudButton>
                    </MudStack>
                }
            }
        </MudPaper>
    </MudTooltip>

    <MudButton OnClick="@(() => OnCheckCallback())">检查数据</MudButton>
</MudCard>

@code {
    [Parameter]
    public required BaseInfo BaseInfo { get; set; }
    private string? NewLocaleName { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        BaseInfo.Type ??= SicType.Common;
    }

    private void OnCheckCallback()
    {
        List<string> warning = [];
        if (BaseInfo.Id?.Length != 24)
        {
            BaseInfo.Id = new MongoId();
        }
        if (BaseInfo.ParentId?.Length != 24)
        {
            BaseInfo.ParentId = null;
        }
        if (BaseInfo.CloneId?.Length != 24)
        {
            BaseInfo.CloneId = null;
        }
        if (BaseInfo.HandbookParentId?.Length != 24)
        {
            BaseInfo.HandbookParentId = null;
        }
        if (BaseInfo.TraderId?.Length != 24)
        {
            BaseInfo.TraderId = null;
        }

        if (BaseInfo.ParentId is null)
        {
            warning.Add("ParentId没有设置非空且24个字符长度的MongoId!");
        }
        BaseInfo.Type ??= SicType.Common;
        if (BaseInfo.Name?.Length == 0)
        {
            BaseInfo.Name = null;
        }
        if (BaseInfo.Description?.Length == 0)
        {
            BaseInfo.Description = null;
        }

        if (BaseInfo.FleaPrice < 1) BaseInfo.FleaPrice = 1;
        if (BaseInfo.HandbookPrice < 1) BaseInfo.HandbookPrice = 1;
        

        if (warning.Count > 0)
        {
            Snackbar.Add("警告: " + string.Join(", ", warning));
        }
    }

    private void OnCreateLocaleCallback()
    {
        if (NewLocaleName?.Length == 2)
        {
            BaseInfo.Locales ??= new Dictionary<string, LocaleDetails>();
            BaseInfo.Locales.TryAdd(NewLocaleName, new LocaleDetails());
        }
        NewLocaleName = null;
    }

    private void OnDeleteLocaleCallback(string locale)
    {
        BaseInfo.Locales?.Remove(locale);
    }
}